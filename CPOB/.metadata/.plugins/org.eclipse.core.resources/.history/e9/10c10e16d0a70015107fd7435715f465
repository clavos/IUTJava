import java.sql.*;

public class OutilsJDBC {
	static Connection co = null;

	public static Connection openConnection() {
		try {
			Class.forName("com.mysql.jdbc.Driver");
			co = DriverManager.getConnection("jdbc:mysql://localhost:3306/projet_cpo", "root", "");

		} catch (ClassNotFoundException e) {
			System.out.println("il manque le driver oracle");
			System.exit(1);
		} catch (SQLException e) {
			System.out.println("impossible de se connecter à l'url : jdbc:mysql://localhost:3306/projet_cpo");
			System.exit(1);
		}
		return co;
	}

	public static ResultSet exec1Requete(String requete, Connection co, int type) {
		ResultSet res = null;
		try {
			Statement st;
			if (type == 0) {
				st = co.createStatement();
			} else {
				st = co.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,
						ResultSet.CONCUR_READ_ONLY);
			}
			;
			res = st.executeQuery(requete);
		} catch (SQLException e) {
			System.out.println("Problème lors de l'exécution de la requete : "
					+ requete);
		}
		;
		return res;
	}

	public static void closeConnection() {
		try {
			co.close();
			System.out.println("Connexion fermée!");
		} catch (SQLException e) {
			System.out.println("Impossible de fermer la connexion");
		}
	}

	OutilsJDBC() {

		Connection co = OutilsJDBC.openConnection();
		System.out.println("connection ouverte");

	}
// TEESTTTTT
	public static String test() {
		String requete, retourne = "";
		try {
			requete = ("select * from compte");
			ResultSet resultat = exec1Requete(requete, co, 1);
			while (resultat.next()) {
				retourne = resultat.getString("login");
			}
		} catch (SQLException e) {
			System.out.println("Erreur 3");
		}
		return retourne;
	}
	
	// On insere la soutenance lié à la session
	public static void insererSoutenance (Session session){
		String requete= "SELECT COUNT(*) AS nb FROM soutenance WHERE numCompte ='"+session.numCompte+"'";
		int res =0;
		
		try {
			ResultSet resultat = exec1Requete(requete, co, 1);
			while (resultat.next()) {
			res = resultat.getInt("nb");
			}
			
			if(res==1){
				requete ="UPDATE soutenance SET periode ='"+2+"', jour ='"+2+"', mois ='"+2+"' WHERE numCompte ='"+session.numCompte+"'";
			}
			
		} catch (SQLException e) {
			System.out.println("Erreur 1");
		}
	}
	
	public static void soutenance(Soutenance soutenance, Session session){
		String requete = "SELECT COUNT(*) FROM soutenance WHERE numCompte ='"+session.numCompte+"'";
		int res =0;
		try {
			ResultSet resultat = exec1Requete(requete, co, 1);
			while (resultat.next()) {
			res = resultat.getInt("nb");
			}
			//A MODIFIER
			if(res==1){
				requete ="UPDATE soutenance SET periode ='"+soutenance.periode+"', jour ='"+soutenance.jour+"', mois ='"+soutenance.mois+"' WHERE numCompte ='"+session.numCompte+"'";
			}
			else{
				requete ="INSERT INTO soutenance VALUES ('"+soutenance.periode+"','"+session.numCompte+"','"+soutenance.jour+"',"+soutenance.mois+"')";

			}
			
		} catch (SQLException e) {
			System.out.println("Erreur 4");
		}
	}
	
	// Un utilisateur se connecte à sa session
	public static void login(Session session){
		boolean verif=false;
		int res =0;
		String requete= "SELECT COUNT(*) AS total FROM compte WHERE login='"+session.login+"' AND mdp='"+session.mdp+"'";
		String requete2= "SELECT numCompte FROM compte WHERE login='"+session.login+"' AND mdp='"+session.mdp+"'";

		try {
			ResultSet resultat = exec1Requete(requete, co, 1);
			while (resultat.next()) {
				if( resultat.getInt("total")==0){
					verif =false;
				}
				if( resultat.getInt("total")==1){
					verif =true;
				}
			}
			
			if(verif){
				
				resultat = exec1Requete(requete2, co, 1);
				while (resultat.next()) {
					res = resultat.getInt("numCompte");
				}
			}
		} catch (SQLException e) {
			System.out.println("Erreur 2");
		}
		session.numCompte = res;
		
	}

}
